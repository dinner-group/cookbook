# VMD as an Analysis Tool
VMD, especially when integrated with the molecular dynamics package NAMD, can be much more than a visualization and rendering package. This page will illustrate some of the most useful VMD/NAMD functionalities for interpreting and analyzing MD trajectories. To use this page, you need to be familiar with the basics of TCL scripting in VMD, which you can learn with [this tutorial.](http://www.ks.uiuc.edu/Training/Tutorials/vmd/tutorial-html/node4.html) An example of a more complex TCL script that could be used for data analysis is at the end of [this section](http://www.ks.uiuc.edu/Training/Tutorials/vmd/tutorial-html/node5.html) of the tutorial. Much of this type of scripting can be done via the GUI - however, you can't use the GUI tp process a large amount of data from a production run on Midway. For this, scripting is much more useful. You can run a tcl script in the GUI by typing "source ${SCRIPT\_NAME}.tcl" in the Tk Console (input for tcl scripting in the GUI), accessed by going to Extensions → Tk Console. To run on via the command line (to, for example, run on a compute node) you can use the following command:

    #If you do not need to feed in any arguments to your script, omit the -arg flag
    vmd -dispdev text -e ${SCRIPT_NAME}.tcl -args ${ARGUMENTS}

This will ensure that VMD is loaded in text only mode (the only way to have a SLURM job run via sbatch), and make it load and run your desired script.

Keep in mind that PLUMED/GROMACS can also perform many of these functions. Sometimes, VMD seems easier to me. It's up to you to choose your favorite tool. To see a list of the analysis tools available natively in GROMACS, check out the [command line reference section of the User Guide.](http://manual.gromacs.org/documentation/2018/user-guide/cmdline.html)

Also, a quick word of warning: VMD interprets any number with leading zeros (008 for 0, for example) as an [octal number](https://wiki.tcl-lang.org/page/Tcl+and+octal+numbers), meaning you can't do any mathematical operations with these types of numbers if they contain either an 8 or a 9. In general, this type of padding is good for file management/ordering. With VMD, however, this is not the case. 

Atom Selection (to Generate .ndx Files)
---------------------------------------

One of the most basic functions of scripting is to get atom IDs of specific selections. These may be needed for ndx files that will be used by either GROMACS or PLUMED suring sampling, or for various analysis techniques like PyEMMA. Suppose for example, you wanted to measure the number of backbone contacts between two proteins during a dissociation. PLUMED can do this (see [PLUMED Tips and Tricks](/display/thecookbook/PLUMED+Tips+and+Tricks)), but it needs the atom IDs for every backbone atom involved in either protein. It is perhaps easiest (certainly the neatest) to feed these into PLUMED using .ndx files, where you name specific selections and give all of the atom IDS. Open the TK console (input for tcl scripting in the GUI)  by going to Extensions → Tk Console. Then use the following commands to select the one of the proteins: 

    set prot1 [atomselect top "backbone and fragment 1"]
    #We want these indexed from 1, to match the PDB file
    $prot1 get serial

You can now use the returned atom IDs in your .ndx file. This type of process is particularly helpful as your selections become more complex. Be careful to use the appropriate keyword, either index or serial, depending if you want the atom IDs to be indexed from 0 or 1. The GROMACS equivalent is [make\_ndx](http://manual.gromacs.org/documentation/2018.4/onlinehelp/gmx-make_ndx.html).

Number of Hydrogen Bonds (hbonds plugin)
----------------------------------------

You can also use VMD to calculate the number of hydrogen bonds between certain residues, or between a residue and water, as time progresses in your simulation. The is a TCL script to do just that. It is specific to a simulation In was running, but it is a useful example. It uses the hbonds plugin, which you should read about **[HERE](https://www.ks.uiuc.edu/Research/vmd/plugins/hbonds/)**.

    #Get from the command line the ID# of the file we should be reading
    set rep [lindex $argv 0]

    #Convert that ID# into a filename
    set nim 28
    set s [expr $rep / $nim]
    set i [expr $rep % $nim]
    set ss [format "%02d" $s]
    set ii [format "%02d" $i]

    #We want to measure hydrogen bonds here, so we need that package
    package require hbonds
    #Load the NAMD structure file (.psf file, automatically generated by CHARMM-GUI)
    mol new 3w7y_solv.psf

    #Load all of the trajectories of interest
    #Here, I first loaded 50 trajectories from an initial batch of replica exchange umbrella sampling
    #Then, I loaded 50 more supplemental trajectories
    for {set it 1} {$it < 51} {incr it} {
    set itit [format "%02d" $it]
    mol addfile ../.. /s${ss}i${ii} /iter_${itit}.xtc waitfor all
    }
    for {set it 51} {$it < 101} {incr it} {
    set itit [format "%02d" $it]
    mol addfile ../.. /supp_L/s${ss}i${ii} /iter_${itit}.xtc waitfor all
    }

    #Measure the hydrogen bonds between two specific residues of interest. You could
    #also do this between a specific residue and all the water within 3 A of that residue
    #You would just need to chnage the atomselection and add the -upsel yes flag
    # See [https://www.ks.uiuc.edu/Research/vmd/plugins/hbonds/](https://www.ks.uiuc.edu/Research/vmd/plugins/hbonds/) for details
    hbonds -sel1 [atomselect top "segname PROA and resid 42" ] \
    -sel2 [atomselect top "segname PROC and resid 50" ] \
    -writefile yes \
    -upsel no \
    -plot no \
    -outfile s${ss}i${ii}_B21B29.dat \
    exit

The GROMACS equivalent is the [hbond](http://manual.gromacs.org/documentation/2018/onlinehelp/gmx-hbond.html) command. 

The Alpha Helix/Beta Sheet Content of a Protein
-----------------------------------------------

Often times, it is nice to measure what specific residues are either alpha helices or beta sheets as the simulation proceeds. You can use this for a collective variable like % beta sheet content, which is relevant in aggregating proteins, for example. In the following example, I wanted to measure whether each residue was involved in either a beta sheet or an alpha helix for every frame in my simulation. This script outputs two files, each 52 columns, which has a binary string that says whether each residue was involved in either a beta sheet or an alpha helix, respectively. Again, this is quite specialized to my specific simulation, but it should serve as a good example. You could, for example, modify this example to calculate the overall percent helicity of a protein. 


    #You need to run the same loading procedure as before, won't replicate it here to avoid clutter
    #Determine the number of frames to loop through
    set num_steps [molinfo top get numframes]
    
    #Open output file
    set fil_a [pen output /s${ss}i${ii}_a.txt w]
    set fil_b [pen output /s${ss}i${ii}_b.txt w]
    
    #Loop through all of your frames
    for {set frame 0} {$frame < $num_steps} {incr frame} {
        #Update the frame
        puts "start frame $frame... "
        animate goto $frame
        display update ui
        mol ssrecalc 0
    
        #Get the atom ids for all residues that are either alpha helices or beta sheets
        set helix [atomselect top "helix" frame $frame]
        set sheet [atomselect top "sheet" frame $frame]
        set helix_index [$helix get index]
        set sheet_index [$sheet get index]
        $helix delete
        $sheet delete
    
        #Define the lists that will eventually be outputted
        set sec_lista {}
        set sec_listb {}
    
        #Loop through all of the residues in the protein
        for {set res 1} {$res < 52} {incr res} {
            #Find the index of the alpha carbon for each residue
            set C_alpha1 [atomselect top "segname PROA and resid $res and name CA" frame $frame]
            set C_alpha1_index [$C_alpha1 get index]
            $C_alpha1 delete
    
            #Determine if that atom is an alpha helix, a beta sheet, or neither. Append the output files accordingly
            if {[lsearch $sheet_index $C_alpha1_index] >= 0} {
                lappend sec_lista 0
                lappend sec_listb 1
            } elseif {[lsearch $helix_index $C_alpha1_index] >= 0} {
                lappend sec_lista 1
                lappend sec_listb 0
            } else {
                lappend sec_lista 0
                lappend sec_listb 0
            }
        }
    #Print to the output files
    puts $fil_a $sec_lista
    puts $fil_b $sec_listb
    }
    
    close $fil_a
    close $fil_b
    exit

The GROMACS/PLUMED equivalent is some combination of the [helix](http://manual.gromacs.org/documentation/2018/onlinehelp/gmx-helix.html) command, and PLUMED's [helicity](https://www.plumed.org/doc-v2.5/user-doc/html/_a_l_p_h_a_r_m_s_d.html) and [beta sheet](https://www.plumed.org/doc-v2.5/user-doc/html/_a_n_t_i_b_e_t_a_r_m_s_d.html) functions. 

Measuring Native Contacts (VMDExtensions plugin)
------------------------------------------------

You can also use VMD and the [VMDExtensions plugin ](http://tonigi.github.io/vmd_extensions/)to measure things like the number of native contacts. That is, you can load a reference structure, determine which atoms are close to each other in the native state, and then track those specific contacts as the simulation progresses. To do this, you will need to download the plugin, and make sure yu load it before running the needed commands. An example is given below. 
    #You need to run the same loading procedure as before, won't replicate it here to avoid clutter
    # Load the needed extension that you downloaded
    source ../../.. /essentials/VMDextensions .tcl
    set outfile [pen "s${ss}i${ii}_${cutoff}_natint.txt" w]
    
    # Choose two things to measure the native contacts between
    set inter1 [ atomselect top "noh and fragment 1 and resid 30 to 51" ]
    set inter3 [ atomselect top "noh and fragment 3 and resid 30 to 51" ]
    
    # Use first trajectory frame as a reference
    $inter1 frame 0
    $inter3 frame 0
    
    # Make the reference - using the first frame, measure what atoms are in contact,
    # and then only measure that set of contacts from now on
    set refi [ prepareNativeContacts $cutoff $inter1 $inter3]
    
    ## Now, for each frame,
    forFrames fno $frag1a {
        # Change the frame to the new frame number
        $inter1 frame $fno
        $inter3 frame $fno
        
        #Measure the number of native contacts
        set nci [measureNativeContacts $refi $cutoff $inter1 $inter3]
        # and print
        puts $outfile "$nci"
    }
    
    close $outfile
    exit

Measuring Interaction Energies (NAMD and NAMDEnergy plugin)
-----------------------------------------------------------

You can also use NAMD to measure the non-bonded (i.e., VDW and electrostatic) interaction energies between certain residues/groups. As with most of the examples given here, you can also do this with GROMACS using the `-rerun` flag to `mdrun`, which will take in a trajectory and output specific energies that might not have been reported in the original simulation, based on a new `.mdp` file. Again, it's up to you to decide your preferred tool. If you choose to use NAMD and VMD, an example is given below. Note that in order for this to run correctly on a cpmute node, you will need to explicitly run `module load namd` before calling vmd/running the tcl script. You will also need to explicitly load the [NamdEnergy plugin ](https://www.ks.uiuc.edu/Research/vmd/plugins/namdenergy/)in your script. Look through the NAMDEnergy documentation for tips on proper use. You also might need the namd-readable version of the water\_ions parameter file ([toppar\_water\_ions\_namd.str](/download/attachments/244551981/toppar_water_ions_namd.str?version=1&modificationDate=1617047052000&api=v2)).

    #You need to run the same loading procedure as before, won't replicate it here to avoid clutter
    #Need the NAMD plug-in
    package require namdenergy
    
    #Calculate VSW and electrostatic energy interactions. Specify some parameters as to the timestep, link to the
    #correct parameter files that describe the energetic interactions, and choose the desired residues.
    #All of these parameters are described in the documentation
    #All of the needed parameter files should have been generated by something like CHARMM-GUI
    namdenergy -ofile s${ss}i${ii}_BctAnt_1.txt \
    -tempname protein_s${ss}i${ii}_BctAnt1 \
    -timemult 2 \
    -skip 0 \
    -stride 2500 \
    -par toppar /par_all36m_prot.prm -par toppar/par_all36_na .prm \
    -par toppar /toppar_all36_na_nad_ppi .str -par toppar /par_all36_lipid .prm \
    -par toppar /toppar_water_ions_namd .str -par toppar /par_all36_carb .prm \
    -par toppar /par_all36_cgenff .prm -par toppar /toppar_all36_prot_na_combined .str \
    -sel [atomselect top "segname PROA and resid 49 to 51" ] [atomselect top "segname PROA and resid 1 to 3" ] \
    -elec -vdw
    
    exit

Measuring Solvent Accessible Surface Areas (SASAs)
--------------------------------------------------

You can also use VMD's [measure](https://www.ks.uiuc.edu/Research/vmd/vmd-1.8.3/ug/node121.html) command to calculate a variety of things, including the solvent accessible surface area of particular residues/selections. The GROMACS equivalent is the gmx [sasa](http://manual.gromacs.org/documentation/2018/onlinehelp/gmx-sasa.html) command.

Fixing periodic boundary conditions (PBC)
-----------------------------------------
Often the PBC wrapping in simulations makes it impossible to compute CVs correctly, so you will want to wrap your protein in the the same box and not have it go over the edge (usually). This can be done in PLUMED as explained [here](./%5BMD%5D-Strange-discontinuities-in-distances-or-RMSDs-in-my-trajectories.md]) but you can also preprocess your trajectories in VMD using the [pbctools](https://www.ks.uiuc.edu/Research/vmd/plugins/pbctools/) package.

An example of a script to center the (wrapped, or whole) protein in the box is given:
```
package require pbctools

# these lines load the file, they should be changed 
# according to your needs
set psfname civsd-all
set dcdname [lindex $argv 0]
set dirpsf /project/dinner/scguo/ci-vsd
set dirdcd /project/dinner/scguo/ci-vsd/pmepot
set firstframe [lindex $argv 1]
set lastframe [lindex $argv 2]
set molid [mol new $dirpsf/$psfname.prmtop]
mol addfile $dirdcd/$dcdname.dcd first $firstframe last $lastframe waitfor all

set iframe [molinfo top get frame]

# this command makes sure the protein is whole and the COM is
# centered in the box
pbc wrap -centersel "protein" -center com -compound residue -all

# this for loop goes through each atom of the protein and shifts
# them so overall they are centered
for {set i 0} {$i <= $iframe} {incr i} {
    set sel [atomselect top "protein and backbone" frame $i]
    foreach {xi yi zi} [measure center $sel] {}
    set pbcbox [pbc get -first $i -last $i]
    set px [lindex [lindex $pbcbox 0] 0]
    set py [lindex [lindex $pbcbox 0] 1]
    set pz [lindex [lindex $pbcbox 0] 2]
    set xm [expr $xi - 0.5*$px]
    set ym [expr $yi - 0.5*$py]
    set zm [expr $zi - 0.5*$pz]

    pbc wrap -sel "not protein" -compound res -shiftcenter "$xm $ym $zm" -first $i -last $i
    set sel1 [atomselect top all frame $i]
    set comx [expr -1 * $xi]
    set comy [expr -1 * $yi]
    set comz [expr -1 * $zi]
    $sel1 moveby "$comx $comy $comz"
}

# writes the final coordinates
animate write dcd $dirdcd/${dcdname}_wrap.dcd waitfor all

exit
```
  
Related Pages
------------
*   [PLUMED Tips and Tricks](/display/thecookbook/PLUMED+Tips+and+Tricks) 
*   [VMD as an Analysis Tool](/display/thecookbook/VMD+as+an+Analysis+Tool)
* [\[GM4\] Only one job runs at a time](/display/thecookbook/%5BGM4%5D+Only+one+job+runs+at+a+time)
*  [Molecular Dynamics Essentials](/display/thecookbook/Molecular+Dynamics+Essentials)
    
*  [\[MD/VMD\] "Expected integer but got 08" Error When Running TCL Script](/pages/viewpage.action?pageId=249004208)