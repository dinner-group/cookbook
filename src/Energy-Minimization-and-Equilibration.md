# Energy-Minimization-and-Equilibration.md
Before you can start any simulation, you need to take your solvated structure (produced either by GROMACS itself or as the output of [CHARMM-GUI](/display/thecookbook/Building+a+System+With+CHARMM-GUI)) and equilibrate it, to make sure it won't blow up when you try to use it. The workflow that will be presented here reflects the best practices in the Dinner Group - people do this many different ways, some more rigorous than others. This procedure is fairly thorough, but the effort is worth the stability and reliability of your simulation. It also assumes that you have a solvated the initial structure, placed ions, chosen a force field, and generated position restraints topology file(s), and an index file to specify protein and solvent atoms. This walkthrough will also assume that you are already familiar with GROMACS, and have completed the [Lysozyme in Water](http://www.mdtutorials.com/gmx/lysozyme/index.html) tutorial. Broadly, the procedure is made up of the following 5 steps:

1.  Energy Minimization 
2.  NVT equilibration _with_ position restraints
3.  NPT equilibration _with_ position restraints
4.  NPT equilibration _without_ position restraints
5.  NVT equilibration _without_ position restraints

We will look at each one of these steps individually. In general, mdp options will be as in the CHARMM-GUI defaults, but with the changes recommended in the [MDP options](/display/thecookbook/MDP+options) page. Note that CHARMM-GUI does not by default generate input parameters for all of the steps outlined above. You can edit and then use their default _Energy Minimization_ and _NVT Equilibration with Position Restraints_ mdp files. You can edit their _NVT Equilibration with Position Restraint_s mdp file to generate the _NPT Equilibration with Position Restraints_ mdp file. You can then take their so-called "production" mdp file and edit it to create the _NPT and NVT equilibrations without position restraints_ files. I will also be attaching example mdp files, but you shouldn't just plug these in and run them - you should make sure that everything makes sense and that it is appropriate for your system. You can also look up previous MD papers by members of the group ([Lu's PNAS Kai paper](https://www.pnas.org/content/115/49/E11475), [Adam's JPCB Insulin Paper](https://pubs.acs.org/doi/10.1021/acs.jpcb.0c03521)) to see the equilibration procedure they followed. You can by all means play with parameters to fit your simulation. 

The GROMACS commands needed to run each step can be found **[HERE](/download/attachments/244551977/README?version=3&modificationDate=1593700346000&api=v2)**. You should absolutely change around things like naming conventions or number of cores/nodes you are requesting to fit your specific system. As you go through this process, make sure you write everything down (all your parameter choices, barostat and thermostat choices, simulation lengths, etc). You will need it when eventually writing a Methods section in a paper. You should always explicitly be monitoring the convergence of your simulations, by explicitly monitoring the variables of interest. Running this procedure won't do anything if convergence doesn't actually happen. I also **highly** recommend looking at every one of your trajectories in VMD. That advice goes for all MD simulations, really. Looking at variables and graphs can only get you so far. Many times, you only find out something is wrong when you see it in the trajectory. As a general note, if your molecule encounters the boundary, it will wrap around to the other side due to [periodic boundary conditions](/display/thecookbook/%5BMD%5D+Strange+discontinuities+in+distances+or+RMSDs+in+my+trajectories). This is not manifestly a bad thing, but it does make the VMD visualization messy if you are using a style something like Licorice or NewCartoon. Using DynamicBonds or VDW will prevent this. You can also explicitly re-center your trajectory using [gmx trjconv](http://manual.gromacs.org/2019.4/onlinehelp/gmx-trjconv.html), meaning you can use the NewCartoon style all you want.

1. Energy Minimization
----------------------

The first step is to relax any heinous steric overlaps or improper geometry. Here, we will run a steepest descent algorithm until the maximum force felt by the molecule falls below 1000 kJ/ (mol nm). This step is very much similar to what is listed in the Lysozyme in Water tutorial. **[HERE](/download/attachments/244551977/step4.0_minimization.mdp?version=1&modificationDate=1591306546000&api=v2)** is an example mdp file. You should follow the directions in the lysozyme tutorial to determine if your system's energy is actually minimized. 

2\. NVT Equilibration (_with_ position restraints)
--------------------------------------------------

We now need to equilibrate the solvent and make sure the solvent is at the correct temperature. We will do this by running a constant volume Langevin dynamics simulation with position restraints. **[HERE](/download/attachments/244551977/step4.1_equilibration.mdp?version=1&modificationDate=1591307114000&api=v2)** is an example mdp file. This should be done with a timestep of 1 fs, not the default 2 fs. This simulation can be relatively short (100 ps), as temperature is relatively quick to equilibrate. You should **always** check the temperature of your simulation (monitoring with xmgrace as outlined in the lysozyme tutorial) to ensure you are actually converged. Simulate for longer if you are not. Make sure to choose the time constant for Langevin Dynamics according to what type of simulation you eventually want to run. Also note that in this mdp file I use the PROT and SOL\_ION groups. These groups, identified in my [index file](/download/attachments/244551977/index.ndx?version=1&modificationDate=1591308298000&api=v2), just list the atomic indices of all protein and solvent atoms, respectively. The index file is entirely specific to your system of interest, so you will have to generate your own, and feed it into grompp by using the -n flag. 

3\. NPT Equilibration (_with_ position restraints)
--------------------------------------------------

Now we will do a similar thing, but trying to converge the pressure to 1 bar. While, in general, we will not be running NPT simulations, it is a good idea to make sure the initial pressure is not wildly off. **[HERE](/download/attachments/244551977/step5_production.mdp?version=1&modificationDate=1591307408000&api=v2)** is an example mdp file. Note that this simulation is much longer, on the order of 10 ns, using the default timestep of 2 fs. This is because pressure is much slower to converge. Again, be sure to check the pressure and density convergence using xmgrace. These won't converge quite as nicely as temperature does, but it should look reasonable. Run for longer if it does not. We are fine using the Parrinello-Rahman barostat here because we will only be using it for equilibration. Hopefully any wonky-ness it might introduce will be addressed in the later NVT equilibration. Note that any time you continue a simulation, you should feed the input velocities into grompp using the -t flag. The file you need for this is the .cpt file automatically generated at the end of any GROMACS run.

4\. NPT Equilibration (_without_ position restraints)
-----------------------------------------------------

We now want to determine the correct box size to use for our future NVT simulations. If you remember, we specified a box size earlier, when building the system. However, NPT simulations, by design, allow the box size to fluctuate in order to equilibrate the pressure. So, we want to find the average box size from a restraint-free simulation, which we will then set as the box size for our future NVT simulations. In my experience, this means that the box size that we actually end up using will be smaller than the box size we specified when building the system. But so it goes. Regardless, **[HERE](/download/attachments/244551977/step6_npt_boxsize.mdp?version=1&modificationDate=1591308536000&api=v2) **is an example mdp file for a 1 ns simulation, normally sufficient to converge the box size. You can then measure the average box size and change the box size of the output .gro file by using the commands in the previously linked [README file](/download/attachments/244551977/README?version=3&modificationDate=1593700346000&api=v2). Again, make sure to actually monitor the convergence using xmgrace, and only average the box size after it has converged. Run for longer if you need to. 

5\. NVT Equilibration (_without_ position restraints)
-----------------------------------------------------

This should be the final step. Once we have the new box size, we want to run a relatively long NVT simulation to make sure we burn-in the simulation, meaning everything is completely equilibrated under the conditions we will actually be using for real simulations. **[HERE](/download/attachments/244551977/step7_nvt_burnin.mdp?version=1&modificationDate=1591309326000&api=v2)** is an example mdp file for a 5 ns simulation. This will also work as a template for general production runs, although you might want to change the output settings as discussed in [MDP options](/display/thecookbook/MDP+options), especially if you are using PLUMED. You will also want to make sure the time constant you are using for the Langevin Dynamics is appropriate. The output gro and cpt files from this step can be used for all further simulations, provided nothing strange happened in this process (which you should be checking for using xmgrace and VMD). Also a good thing to do here is to measure the RMSD of your current structure to both your solvated starting structure and the crystal structure (this can be done either using PLUMED of VMD). Ideally your structure will not have changed dramatically during the course of the equilibration. All we want to do is relax extraordinarily high-energy areas of protein and solvent, and prep the structure for use in actual simulations. 

Congrats, you're ready to run real simulations now! In general, please feel free to ask older grad students about any step in this process. It is a bit tedious and not super interesting, but the accuracy and reliability of all of your future simulations are predicated on equilibrating correctly.